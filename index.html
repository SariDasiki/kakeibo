<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Axios CRUDアプリ（フォーム編集）</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group { margin-bottom: 10px; }
        .label { display: inline-block; width: 80px; }
        .error-message { display: none; color: red; margin-left: 5px; }

        /* テーブル全体の基本スタイル */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td { border: 1px solid #000; border-collapse: collapse; padding: 5px; }

        /* テーブルヘッダーの枠線を太くする */
        th {
            border: 3px solid #000; /* ヘッダーの枠線を太く */
        }

        /* ボタンの初期スタイル */
        #addButon, .save-edit-button, .cancel-edit-button {
            padding: 8px 15px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        #addButon {
            background-color: #007bff; /* 初期の色（青） */
        }

        /* ボタンがクリックされた後のスタイル */
        #addButon.clicked-button {
            background-color: #28a745; /* クリック後は別の色（例: 緑） */
        }

        /* 削除・編集ボタンのスタイル */
        .action-button {
            padding: 5px 10px;
            margin-left: 5px; /* ボタン間のスペース */
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: white;
        }

        .delete-button {
            background-color: #dc3545; /* 赤色 */
        }

        .edit-button {
            background-color: #ffc107; /* 黄色 */
            color: black; /* 黄色には黒文字が見やすい */
        }

        /* 編集フォームのスタイル */
        #editForm {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: none; /* 初期状態では非表示 */
        }
        #editForm h2 {
            margin-top: 0;
            color: #333;
        }
        .edit-form-buttons {
            margin-top: 20px;
            text-align: right;
        }
        .save-edit-button {
            background-color: #28a745;
            margin-left: 10px;
        }
        .cancel-edit-button {
            background-color: #6c757d;
        }
    </style>
</head>
<body>

<form id="userForm">
    <div class="form-group">
        <label class="label" for="studentName">名前</label>
        <input type="text" id="studentName" name="studentName">
        <div id="nameError" class="error-message">名前を入力してください</div>
    </div>
    <div class="form-group">
        <label class="label" for="studentAge">年齢</label>
        <input type="number" id="studentAge" name="studentAge">
    </div>
    <div class="form-group">
        <label class="label" for="studentEmail">メール</label>
        <input type="email" id="studentEmail" name="studentEmail">
    </div>
    <div class="form-group">
        <label class="label" for="studentnumber">電話</label>
        <input type="text" id="studentnumber" name="studentnumber">
    </div>
    <button type="button" id="addButon">追加</button>
</form>

<hr>

<table id="studentTable">
    <thead>
        <tr><th>ID</th><th>名前</th><th>年齢</th><th>メール</th><th>電話</th><th>操作</th></tr>
    </thead>
    <tbody></tbody>
</table>

<form id="editForm">
    <h2>データ編集</h2>
    <input type="hidden" id="editId" name="editId">
    <div class="form-group">
        <label class="label" for="editName">名前</label>
        <input type="text" id="editName" name="editName">
        <div id="editNameError" class="error-message">名前を入力してください</div>
    </div>
    <div class="form-group">
        <label class="label" for="editAge">年齢</label>
        <input type="number" id="editAge" name="editAge">
    </div>
    <div class="form-group">
        <label class="label" for="editEmail">メール</label>
        <input type="email" id="editEmail" name="editEmail">
    </div>
    <div class="form-group">
        <label class="label" for="editPhone">電話</label>
        <input type="text" id="editPhone" name="editPhone">
    </div>
    <div class="edit-form-buttons">
        <button type="button" class="save-edit-button" id="saveEditButton">保存</button>
        <button type="button" class="cancel-edit-button" id="cancelEditButton">キャンセル</button>
    </div>
</form>


<script>
document.addEventListener('DOMContentLoaded', async () => {
    const API_BASE_URL = 'https://jsonplaceholder.typicode.com/users';

    // DOM要素の取得
    const userForm = document.getElementById('userForm');
    const addButton = document.getElementById('addButon');
    const nameInput = document.getElementById('studentName');
    const ageInput = document.getElementById('studentAge');
    const emailInput = document.getElementById('studentEmail');
    const phoneInput = document.getElementById('studentnumber');
    const nameError = document.getElementById('nameError');
    const tableBody = document.querySelector('#studentTable tbody');

    // 編集フォームのDOM要素
    const editForm = document.getElementById('editForm');
    const editIdInput = document.getElementById('editId');
    const editNameInput = document.getElementById('editName');
    const editAgeInput = document.getElementById('editAge');
    const editEmailInput = document.getElementById('editEmail');
    const editPhoneInput = document.getElementById('editPhone');
    const editNameError = document.getElementById('editNameError'); // ★追加: 編集フォームのエラー要素を取得
    const saveEditButton = document.getElementById('saveEditButton');
    const cancelEditButton = document.getElementById('cancelEditButton');

    let studentData = []; // アプリケーションのデータ配列

    // --- 共通関数の定義 ---
    function getFormData(type = 'add') {
        if (type === 'add') {
            return {
                name: nameInput.value.trim(),
                age: parseInt(ageInput.value.trim()) || 0,
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim()
            };
        } else { 
            return {
                name: editNameInput.value.trim(),
                age: parseInt(editAgeInput.value.trim()) || 0,
                email: editEmailInput.value.trim(),
                phone: editPhoneInput.value.trim()
            };
        }
    }

    // validate関数はエラー表示要素を引数で受け取るようにする
    function validate(data, errorElement) { // ★修正: errorElementを引数に追加
        if (!data.name) {
            showError(errorElement); // ★修正: 渡されたerrorElementを使用
            return false;
        }
        // エラーがない場合はエラーメッセージを非表示にする
        errorElement.style.display = 'none'; // ★追加: エラーがない場合の処理
        return true;
    }

    function showError(element) {
        element.style.display = 'inline';
        setTimeout(() => { element.style.display = 'none'; }, 2000);
    }

    // 全てのエラーメッセージをクリアする関数を追加
    function clearAllErrors() {
        nameError.style.display = 'none';
        editNameError.style.display = 'none';
    }

    // --- CRUD操作（Axiosのみ） ---
    async function fetchAllData() {
        try {
            const response = await axios.get(API_BASE_URL);
            studentData = response.data.map(item => ({
                id: item.id,
                name: item.name,
                age: item.id % 40 + 20,
                email: item.email,
                phone: item.phone
            }));
            renderTable();
        } catch (error) {
            console.error('データ取得に失敗しました:', error);
            alert('データ取得に失敗しました。');
        }
    }

    async function createData(data) {
        try {
            const response = await axios.post(API_BASE_URL, data);
            const newData = {
                id: response.data.id,
                name: data.name,
                age: data.age,
                email: data.email,
                phone: data.phone
            };
            studentData.push(newData);
            renderTable();
            clearFormInputs('add'); // 'add'を指定して新規フォームをクリア
        } catch (error) {
            console.error('データ追加に失敗しました:', error);
            alert('データ追加に失敗しました。');
        }
    }

    async function updateData(id, updatedData) {
        try {
            // ★修正: テンプレートリテラルの`と${}`構文が正しくなるように変更
            await axios.put(`${API_BASE_URL}/${id}`, updatedData);
            const index = studentData.findIndex(item => item.id === id);
            if (index !== -1) {
                studentData[index] = { ...studentData[index], ...updatedData };
                renderTable();
            }
            hideEditForm();
        } catch (error) {
            console.error('データ更新に失敗しました:', error);
            alert('データ更新に失敗しました。');
        }
    }

    async function deleteData(id) {
        if (!confirm('本当に削除しますか？')) return;
        try {
            // ★修正: テンプレートリテラルの`と${}`構文が正しくなるように変更
            await axios.delete(`${API_BASE_URL}/${id}`);
            studentData = studentData.filter(item => item.id !== id);
            renderTable();
        } catch (error) {
            console.error('データ削除に失敗しました:', error);
            alert('データ削除に失敗しました。');
        }
    }

    function addTableRow(data) {
        const row = document.createElement('tr');
        row.setAttribute('data-id', data.id);
        row.innerHTML = `
            <td>${data.id}</td>
            <td>${data.name}</td>
            <td>${data.age}</td>
            <td>${data.email}</td>
            <td>${data.phone}</td>
            <td>
                <button class="action-button edit-button">編集</button>
                <button class="action-button delete-button">削除</button>
            </td>
        `;
        tableBody.appendChild(row);

        row.querySelector('.edit-button').addEventListener('click', () => {
            showEditForm(data.id);
        });
        row.querySelector('.delete-button').addEventListener('click', () => {
            deleteData(data.id);
        });
    }

    function clearFormInputs(type = 'add') { // ★修正: typeを引数に追加
        if (type === 'add') {
            nameInput.value = '';
            ageInput.value = '';
            emailInput.value = '';
            phoneInput.value = '';
        } else { // type === 'edit'
            editIdInput.value = '';
            editNameInput.value = '';
            editAgeInput.value = '';
            editEmailInput.value = '';
            editPhoneInput.value = '';
        }
    }

    function renderTable() {
        tableBody.innerHTML = '';
        studentData.forEach(data => addTableRow(data));
    }

    function showEditForm(id) {
        const dataToEdit = studentData.find(item => item.id === id);
        if (dataToEdit) {
            editIdInput.value = dataToEdit.id;
            editNameInput.value = dataToEdit.name;
            editAgeInput.value = dataToEdit.age;
            editEmailInput.value = dataToEdit.email;
            editPhoneInput.value = dataToEdit.phone;
            editForm.style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
            clearAllErrors(); // ★追加: 編集フォーム表示時に全てのエラーをクリア
        }
    }

    function hideEditForm() {
        editForm.style.display = 'none';
        clearFormInputs('edit'); // ★修正: 'edit'を指定して編集フォームをクリア
        clearAllErrors(); // ★追加: 編集フォーム非表示時に全てのエラーをクリア
    }

    // --- イベントリスナー ---
    await fetchAllData();

    addButton.addEventListener('click', () => {
        addButton.classList.add('clicked-button');
        setTimeout(() => addButton.classList.remove('clicked-button'), 300);
        const formData = getFormData('add');
        clearAllErrors(); // ★追加: 新規追加前のエラークリア
        if (!validate(formData, nameError)) return; // ★修正: nameErrorを渡す
        createData(formData);
    });

    saveEditButton.addEventListener('click', () => {
        const id = parseInt(editIdInput.value);
        const updatedData = getFormData('edit');
        clearAllErrors(); // ★追加: 更新前のエラークリア
        if (!validate(updatedData, editNameError)) return; // ★修正: editNameErrorを渡す
        updateData(id, updatedData);
    });

    cancelEditButton.addEventListener('click', () => {
        hideEditForm();
    });
});
</script>
</body>
</html>
